<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coffee Tracker</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  
  <script>
    // Early admin toggle (runs even if later scripts fail)
    (function () {
      try {
        var params = new URLSearchParams(window.location.search);
        if (params.get("admin") === "1") {
          window.__ADMIN__ = true;
          document.addEventListener("DOMContentLoaded", function () {
            var setup = document.getElementById("setup");
            var login = document.getElementById("login");
            var app = document.getElementById("app");
            if (setup) setup.classList.remove("hidden");
            if (login) login.classList.add("hidden");
            if (app) app.classList.add("hidden");
          });
        }
      } catch (e) {}
    })();
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      padding: 26px;
      margin-bottom: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      backdrop-filter: blur(10px);
      position: relative;
    }
    h1 { margin: 0 0 8px 0; color: #2d3748; text-align: center; font-size: 2.3em; }
    h2 { margin: 0 0 12px 0; color: #2d3748; }
    .subtitle { text-align: center; color: #718096; margin-bottom: 18px; }
    .hidden { display: none !important; }

    input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      margin: 10px 0;
    }
    input:focus { outline: none; border-color: #667eea; }

    button {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 650;
      cursor: pointer;
      transition: transform .15s, box-shadow .15s;
      margin-top: 10px;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }

    .btn-primary { background: #667eea; color: #fff; }
    .btn-secondary { background: #48bb78; color: #fff; }
    .btn-danger { background: #f56565; color: #fff; width: auto; padding: 8px 14px; font-size: 14px; }

    .msg { margin-top: 10px; font-size: 14px; }
    .msg.error { color: #c53030; }
    .msg.ok { color: #2f855a; }
    .muted { color: #718096; font-size: 14px; }

    .logout { position: absolute; top: 16px; right: 16px; }

    .coffee-counter { text-align: center; margin-top: 18px; }
    .count { font-size: 3.6em; font-weight: 800; color: #667eea; margin: 8px 0; }
    .coffee-btn { background: #48bb78; color: #fff; font-size: 1.15em; padding: 14px; }

    .history-item {
      display:flex; justify-content:space-between;
      padding: 10px 12px; border-bottom: 1px solid #e2e8f0;
    }

    .leaderboard-item {
      display:flex; justify-content:space-between;
      padding: 10px 12px; background:#f7fafc; margin-bottom: 8px; border-radius: 10px;
    }
    .leaderboard-item.me { background: #667eea; color: #fff; }

    .tabs { display:flex; gap:10px; margin-bottom: 12px; flex-wrap: wrap; }
    .tab {
      padding: 8px 10px; border-radius: 10px; background:#e2e8f0; cursor:pointer; user-select:none;
      flex: 1 1 110px; text-align:center;
    }
    .tab.active { background:#667eea; color:#fff; }

    pre {
      background:#f7fafc; padding: 12px; border-radius: 10px; overflow-x: auto;
      font-size: 12px;
    }
  
    #statsText { font-size: 14px; line-height: 1.5; }
</style>
</head>

<body>
  <div class="container">

    <!-- SETUP (admin only: add ?admin=1) -->
    <div id="setup" class="card hidden">
      <h1><img class="logo" src="icons/icon-192.png" alt="Coffee Tracker logo"><span>Coffee Tracker</span></h1>
      <p class="subtitle">Admin setup (hidden)</p>
      <p class="muted">
        This page is only shown when you open the app with <code>?admin=1</code>.
        Share the normal URL with friends.
      </p>

      <h2 style="margin-top:16px;">SQL (run once)</h2>
      <pre id="sqlBlock">
-- Insecure username-only coffee tracker
-- This stores coffees by username text, with open read/write policies.

create table if not exists public.coffees_by_username (
  id uuid primary key default gen_random_uuid(),
  username text not null,
  timestamp timestamptz not null default now()
);

create index if not exists coffees_by_username_user_ts_idx
  on public.coffees_by_username (username, timestamp desc);

alter table public.coffees_by_username enable row level security;

-- Re-runnable: drop policies if they already exist
drop policy if exists &quot;read all coffees&quot; on public.coffees_by_username;
drop policy if exists &quot;insert coffees&quot; on public.coffees_by_username;
drop policy if exists &quot;update coffees&quot; on public.coffees_by_username;
drop policy if exists &quot;delete coffees&quot; on public.coffees_by_username;

-- Open policies (INSECURE): anyone can read/insert/delete/update.
create policy &quot;read all coffees&quot;
  on public.coffees_by_username for select
  using (true);

create policy &quot;insert coffees&quot;
  on public.coffees_by_username for insert
  with check (true);

create policy &quot;update coffees&quot;
  on public.coffees_by_username for update
  using (true)
  with check (true);

create policy &quot;delete coffees&quot;
  on public.coffees_by_username for delete
  using (true);

-- Optional: leaderboard function (aggregates by username)
create or replace function public.leaderboard_username_since(ts timestamptz)
returns table (username text, coffees int)
language sql
security definer
as $$
  select c.username, count(*)::int as coffees
  from public.coffees_by_username c
  where c.timestamp &gt;= ts
  group by c.username
  order by coffees desc;
$$;

grant execute on function public.leaderboard_username_since(timestamptz) to anon, authenticated;
</pre>

      <button class="btn-secondary" onclick="copySQL()">Copy SQL</button>
      <button class="btn-primary" onclick="goToApp()">Go to app</button>
      <div id="setupMsg" class="msg"></div>
    </div>

    <!-- LOGIN (visible by default to avoid blank screen if JS fails) -->
    <div id="login" class="card">
      <h1><img class="logo" src="icons/icon-192.png" alt="Coffee Tracker logo"><span>Coffee Tracker</span></h1>
      <p class="subtitle">Username-only (no password)</p>

      <h2>Enter username</h2>
      <p class="muted">
        This username is the key for all your data (intentionally insecure). Anyone who knows a username can use it.
      </p>

      <input id="username" placeholder="Username (1‚Äì32 chars)"/>
      <button class="btn-primary" onclick="doLogin()">Continue</button>
      <div id="loginMsg" class="msg"></div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="card">
        <button class="btn-danger logout" onclick="logout()">Log out</button>

        <h1><img class="logo" src="icons/icon-192.png" alt="Coffee Tracker logo"><span>Coffee Tracker</span></h1>
        <p class="subtitle">User: <span id="displayUsername"></span></p>

        <div class="coffee-counter">
          <div class="muted">Coffees today</div>
          <div class="count" id="todayCount">0</div>
          <button class="coffee-btn" onclick="addCoffee()">+ Add Coffee</button>
          <button class="btn-primary" style="margin-top:12px;" onclick="showStats()">View Stats</button>
        </div>

        <h2 style="margin-top:22px;">Recent coffees</h2>
        <div id="history"></div>

      <div id="statsCard" class="card hidden">
        <button class="btn-danger logout" onclick="hideStats()">Close</button>
        <h2 style="text-align:center; margin-top:6px;">üìä Your stats</h2>
        <pre id="statsText"></pre>
        <p class="muted" style="text-align:center; margin-top:10px;">
          Stats are calculated from your coffee history for the current username.
        </p>
      </div>

      </div>

      <div class="card">
        <h2>üèÜ Leaderboard</h2>
        <div class="tabs">
          <div class="tab active" data-view="today" onclick="switchLeaderboard(event)">Today</div>
          <div class="tab" data-view="week" onclick="switchLeaderboard(event)">This Week</div>
          <div class="tab" data-view="month" onclick="switchLeaderboard(event)">This Month</div>
          <div class="tab" data-view="all" onclick="switchLeaderboard(event)">All Time</div>
        </div>
        <div id="leaderboard"></div>
      </div>
    </div>

  </div>

  <script>
    /* BUILD: v12-caffeine-stats */

    // Avoid naming conflict with global 'supabase' from the CDN
    let supabaseClient = null;

    // Hardcoded Supabase configuration (shared for all users)
    // TODO: Replace these with your project values, then redeploy.
    const SUPABASE_URL = "https://xifdmpdzaqbgrfsbzkvr.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_lpJAcX6Jv34NUsRcvcvLKw_m2baOZIz";

    // Admin-only SQL
    const SETUP_SQL = `
-- Insecure username-only coffee tracker
-- This stores coffees by username text, with open read/write policies.

create table if not exists public.coffees_by_username (
  id uuid primary key default gen_random_uuid(),
  username text not null,
  timestamp timestamptz not null default now()
);

create index if not exists coffees_by_username_user_ts_idx
  on public.coffees_by_username (username, timestamp desc);

alter table public.coffees_by_username enable row level security;

-- Re-runnable: drop policies if they already exist
drop policy if exists "read all coffees" on public.coffees_by_username;
drop policy if exists "insert coffees" on public.coffees_by_username;
drop policy if exists "update coffees" on public.coffees_by_username;
drop policy if exists "delete coffees" on public.coffees_by_username;

-- Open policies (INSECURE): anyone can read/insert/delete/update.
create policy "read all coffees"
  on public.coffees_by_username for select
  using (true);

create policy "insert coffees"
  on public.coffees_by_username for insert
  with check (true);

create policy "update coffees"
  on public.coffees_by_username for update
  using (true)
  with check (true);

create policy "delete coffees"
  on public.coffees_by_username for delete
  using (true);

-- Optional: leaderboard function (aggregates by username)
create or replace function public.leaderboard_username_since(ts timestamptz)
returns table (username text, coffees int)
language sql
security definer
as $$
  select c.username, count(*)::int as coffees
  from public.coffees_by_username c
  where c.timestamp >= ts
  group by c.username
  order by coffees desc;
$$;

grant execute on function public.leaderboard_username_since(timestamptz) to anon, authenticated;
`.trim();

    let currentUsername = null;
    let currentLeaderboardView = "today";

    const CAFFEINE_MG_PER_CUP = 70; // mg per coffee


    function el(id) { return document.getElementById(id); }

    function setMsg(id, text, isError=false) {
      const node = el(id);
      if (!node) return;
      node.textContent = text;
      node.className = "msg " + (isError ? "error" : "ok");
    }

    function hideAll() {
      ["setup","login"].forEach(id => el(id)?.classList.add("hidden"));
      el("app")?.classList.add("hidden");
    }

    function show(which) {
      hideAll();
      if (which === "app") el("app")?.classList.remove("hidden");
      else el(which)?.classList.remove("hidden");
    }

    function validUsername(u) {
      if (!u) return false;
      const s = u.trim();
      if (s.length < 1 || s.length > 32) return false;
      if (/[<>]/.test(s)) return false;
      return true;
    }

    function showSetupAdmin() {
      show("setup");
      const pre = el("sqlBlock");
      // SQL is inlined in HTML; keep this as a fallback in case it's empty.
      if (pre && (!pre.textContent || pre.textContent.trim().length === 0)) {
        pre.textContent = SETUP_SQL;
      }
    }

    async function copySQL() {
      try {
        await navigator.clipboard.writeText(SETUP_SQL);
        setMsg("setupMsg", "SQL copied to clipboard.", false);
      } catch {
        setMsg("setupMsg", "Could not copy automatically. Select the SQL and copy manually.", true);
      }
    }

    function goToApp() {
      const url = new URL(window.location.href);
      url.searchParams.delete("admin");
      window.location.href = url.toString();
    }

    function doLogin() {
      const raw = el("username")?.value ?? "";
      const normalized = raw.trim();

      if (!validUsername(normalized)) {
        setMsg("loginMsg", "Invalid username (1‚Äì32 chars).", true);
        return;
      }

      currentUsername = normalized;
      localStorage.setItem("coffee_username", normalized);
      showApp();
    }

    function logout() {
      localStorage.removeItem("coffee_username");
      currentUsername = null;
      show("login");
    }

    function showApp() {
      el("displayUsername").textContent = currentUsername;
      show("app");
      loadData();
    }

    async function addCoffee() {
      const { error } = await supabaseClient
        .from("coffees_by_username")
        .insert([{ username: currentUsername }]);

      if (error) {
        console.error("addCoffee:", error);
        alert("Could not add coffee. Check console.");
        return;
      }

      await loadData();
    }

    async function loadData() {
      const today = new Date();
      today.setHours(0,0,0,0);

      const { data, error } = await supabaseClient
        .from("coffees_by_username")
        .select("timestamp")
        .eq("username", currentUsername)
        .gte("timestamp", today.toISOString())
        .order("timestamp", { ascending: false });

      if (error) {
        console.error("loadData:", error);
        setMsg("loginMsg", "Database error. Did you run the SQL? (Open with ?admin=1 to view it.)", true);
        show("login");
        return;
      }

      el("todayCount").textContent = (data || []).length;

      const history = (data || []).slice(0, 10).map(r => {
        const t = new Date(r.timestamp).toLocaleTimeString();
        return `<div class="history-item"><span>‚òï</span><span>${t}</span></div>`;
      }).join("");

      el("history").innerHTML =
        history || `<p class="muted" style="text-align:center; margin-top:10px;">No coffees yet today.</p>`;

      await loadLeaderboard();
    }

    function switchLeaderboard(evt) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      evt.target.classList.add("active");
      currentLeaderboardView = evt.target.getAttribute("data-view");
      loadLeaderboard();
    }

    async function loadLeaderboard() {
      let startDate = new Date();
      switch (currentLeaderboardView) {
        case "today":
          startDate.setHours(0,0,0,0); break;
        case "week":
          startDate.setDate(startDate.getDate() - 7); break;
        case "month":
          startDate.setMonth(startDate.getMonth() - 1); break;
        case "all":
          startDate = new Date("2000-01-01"); break;
      }

      // Try RPC first; fall back to JS aggregation if RPC isn't installed.
      let rows = null;

      try {
        const { data, error } = await supabaseClient.rpc("leaderboard_username_since", { ts: startDate.toISOString() });
        if (!error) rows = data;
      } catch (e) {}

      if (!rows) {
        const { data, error } = await supabaseClient
          .from("coffees_by_username")
          .select("username")
          .gte("timestamp", startDate.toISOString());

        if (error) {
          console.error("leaderboard fallback:", error);
          el("leaderboard").innerHTML = `<p class="muted" style="text-align:center;">Could not load leaderboard.</p>`;
          return;
        }

        const counts = {};
        (data || []).forEach(r => counts[r.username] = (counts[r.username] || 0) + 1);
        rows = Object.entries(counts).map(([username, coffees]) => ({ username, coffees }))
          .sort((a,b) => b.coffees - a.coffees);
      }

      const html = (rows || []).slice(0, 10).map((row, idx) => {
        const isMe = row.username === currentUsername;
        return `<div class="leaderboard-item ${isMe ? "me" : ""}">
          <span>${idx+1}. ${row.username} ${isMe ? "(You)" : ""}</span>
          <span>${row.coffees} ‚òï</span>
        </div>`;
      }).join("");

      el("leaderboard").innerHTML =
        html || `<p class="muted" style="text-align:center;">No coffees recorded yet.</p>`;
    }

    function hideStats() {
      el("statsCard")?.classList.add("hidden");
    }

    async function showStats() {
      el("statsText").textContent = "Loading stats‚Ä¶";
      el("statsCard")?.classList.remove("hidden");

      const { data, error } = await supabaseClient
        .from("coffees_by_username")
        .select("timestamp")
        .eq("username", currentUsername)
        .order("timestamp", { ascending: true });

      if (error) {
        console.error("stats query:", error);
        el("statsText").textContent = `Could not load stats.

Make sure you ran the SQL (open ?admin=1), and that SELECT is allowed.

Error: ${error.message || error}`;
        return;
      }

      const rows = data || [];
      const total = rows.length;

      if (total === 0) {
        el("statsText").textContent = `Total coffees: 0
Tracking since: (no data)
Average per day: 0.0
Max in a day: 0
Today: 0

Caffeine (70 mg/cup):
‚Ä¢ Today: 0 mg
‚Ä¢ Average/day: 0 mg`;
        return;
      }

      const firstTs = new Date(rows[0].timestamp);
      const firstDate = new Date(firstTs.getFullYear(), firstTs.getMonth(), firstTs.getDate());
      const now = new Date();
      const todayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      const msPerDay = 24 * 60 * 60 * 1000;
      const daysTracked = Math.max(1, Math.floor((todayDate - firstDate) / msPerDay)); // e.g. Jan 5 -> Jan 22 => 17
      const avgPerDay = total / (daysTracked+1);

      const countsByDay = {};
      for (const r of rows) {
        const d = new Date(r.timestamp);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        countsByDay[key] = (countsByDay[key] || 0) + 1;
      }

      let maxInDay = 0;
      for (const k in countsByDay) {
        if (countsByDay[k] > maxInDay) maxInDay = countsByDay[k];
      }

      const todayKey = `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}-${String(todayDate.getDate()).padStart(2,'0')}`;
      const todayCount = countsByDay[todayKey] || 0;

      const startStr = `${firstDate.getFullYear()}-${String(firstDate.getMonth()+1).padStart(2,'0')}-${String(firstDate.getDate()).padStart(2,'0')}`;

      el("statsText").textContent = `Total coffees: ${total}
Tracking since: ${startStr} (${daysTracked} days)
Average per day: ${avgPerDay.toFixed(1)}
Max in a day: ${maxInDay}
Today: ${todayCount}

Caffeine (70 mg/cup):
‚Ä¢ Today: ${(todayCount * CAFFEINE_MG_PER_CUP).toFixed(0)} mg
‚Ä¢ Average/day: ${(avgPerDay * CAFFEINE_MG_PER_CUP).toFixed(0)} mg`;
    }


  window.onload = () => {
      // Admin page must work even if the Supabase CDN is blocked/offline
      const params = new URLSearchParams(window.location.search);
      if (params.get("admin") === "1") {
        showSetupAdmin();
        return;
      }

      // Register service worker (PWA)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").catch(console.error);
      }

      if (typeof window.supabase === "undefined") {
        setMsg("loginMsg", "Supabase library failed to load (network / CDN blocked).", true);
        return;
      }

if (!SUPABASE_URL || SUPABASE_URL.includes("PASTE_YOUR_SUPABASE_URL_HERE") ||
          !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("PASTE_YOUR_SUPABASE_ANON_KEY_HERE")) {
        setMsg("loginMsg", "App not configured. The host must set SUPABASE_URL and SUPABASE_ANON_KEY in index.html.", true);
        // login is visible by default
        return;
      }

      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const savedUser = localStorage.getItem("coffee_username");
      if (savedUser && validUsername(savedUser)) {
        currentUsername = savedUser.trim();
        showApp();
      } else {
        show("login");
      }
    };
  </script>
</body>
</html>
